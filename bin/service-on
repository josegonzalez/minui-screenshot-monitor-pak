#!/bin/sh
bindir="$(dirname "$0")"
progdir="$(dirname "$bindir")"
cd "$progdir" || exit 1
PAK_NAME="$(basename "$progdir")"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$progdir/lib"

main() {
    cd "$SDCARD_PATH" || exit 1
    if [ -f "$LOGS_PATH/$PAK_NAME.service.log" ]; then
        mv "$LOGS_PATH/$PAK_NAME.service.log" "$LOGS_PATH/$PAK_NAME.service.log.old"
    fi

    hotkey="HOTKEY_1"
    if [ -f "$progdir/hotkey" ]; then
        hotkey="$(cat "$progdir/hotkey")"
    fi

    if [ -z "$hotkey" ]; then
        hotkey="HOTKEY_1"
    fi
    if [ "$hotkey" != "HOTKEY_1" ] && [ "$hotkey" != "HOTKEY_2" ]; then
        hotkey="HOTKEY_1"
    fi

    (PROGDIR="$progdir" HOTKEY="$hotkey" "$bindir/screenshot-monitor" >"$LOGS_PATH/$PAK_NAME.service.log" 2>&1 &) &
}

main "$@"
